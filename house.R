#!/usr/bin/env Rscript
# house.R
# 
# Take year and optional state and produce presidential election results. 

library(tidyverse)
library(politicaldata)
library(optparse)

data_dir = "data"
if (! dir.exists(data_dir)) {
  stop(paste("The data directory doesn't exist: ", data_dir))
}

args <- commandArgs(trailingOnly=TRUE)
# test if there is at least one argument: if not, return an error
if (length(args)==0) {
  stop("At least one argument must be supplied (year).", call.=FALSE)
}
year <- args[1]
if (! (year %in% unique(house_results$year))) {
  years = paste(unique(house_results$year), collapse=", ")
  stop(paste("Year provided is not a house election year.",
             years))
}
if (length(args) == 2) {
  state = args[2]
  filename = paste(year, state, "house", "csv", sep=".")
  if (! state %in% unique(house_results$state_abb)) {
    stop("State provided is not in the list of states.")
  }
} else {
  filename = paste(year, "all", "house", sep=".")
}

if (length(args) != 2) {
  data <- house_results[house_results$year == year,
                        c("state_abb", "district", "total_votes", "dem", 
                          "other", "rep")]
} else {
  data <- house_results[house_results$year == year & 
                          house_results$state_abb == state,
                        c("state_abb", "district", "total_votes", "dem", 
                          "other", "rep")]
}
data$district = as.numeric(str_extract(data$district, "\\d+"))
data$district[is.na(data$district)] = 0
print(paste("Writing filename: ", paste(data_dir, filename, sep="/")))
write_csv(data, paste(data_dir, filename, sep="/"))


